Option Explicit

Private Const DATA_FOLDER As String = _
    "C:\Users\zouzh\Downloads"

' Always subtract this offset from Available Stock values (no exemptions)
' If you ever need 1,000 instead of 10,000, change this constant.
Private Const AVAILABLE_STOCK_OFFSET As Double = 10000

' Sheet names to update (both will be processed every run if they exist)
Private SHEETS_TO_UPDATE As Variant


Public Sub UpdateInventoryNEW()
    Dim wbInv As Workbook
    Dim wbSrc As Workbook
    Dim wsSrc As Worksheet

    Dim latestPath As String

    Dim skuColSrc As Long
    Dim availColSrc As Long
    Dim onwayColSrc As Long
    Dim ordAllocColSrc As Long
    Dim dailySalesColSrc As Long

    Dim lastRowSrc As Long
    Dim r As Long
    Dim sku As String

    Dim dictAvail As Object
    Dim dictOnWay As Object
    Dim dictOrder As Object
    Dim dictDaily As Object

    Dim scrn As Boolean
    Dim calc As XlCalculation
    Dim evt As Boolean

    Dim wsInv As Worksheet
    Dim i As Long

    On Error GoTo ErrHandler

    Set wbInv = ThisWorkbook
    SHEETS_TO_UPDATE = Array("采菁", "萌睫")

    ' -------- Speed up --------
    scrn = Application.ScreenUpdating
    calc = Application.Calculation
    evt = Application.EnableEvents

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False

    ' -------- 1) Find latest data workbook --------
    latestPath = FindLatestWorkbook(DATA_FOLDER)
    If latestPath = "" Then
        MsgBox "在库存数据文件夹中未找到任何 Excel 工作簿：" & vbCrLf & DATA_FOLDER, vbCritical
        GoTo CleanExit
    End If

    ' Safely open the latest workbook
    On Error Resume Next
    Set wbSrc = Workbooks.Open(latestPath, ReadOnly:=True)
    If wbSrc Is Nothing Or Err.Number <> 0 Then
        MsgBox "无法打开最新库存数据文件：" & vbCrLf & latestPath & vbCrLf & _
               "错误 " & Err.Number & " - " & Err.Description, vbCritical
        Err.Clear
        On Error GoTo ErrHandler
        GoTo CleanExit
    End If
    On Error GoTo ErrHandler

    If wbSrc.Worksheets.Count = 0 Then
        MsgBox "最新库存数据文件中没有工作表：" & vbCrLf & latestPath, vbCritical
        GoTo CleanExit
    End If

    Set wsSrc = wbSrc.Worksheets(1)  ' 数据文件第一张表，无论英/中文

    ' -------- 2) Source data headers (English / Chinese) --------
    skuColSrc = FindHeaderByCandidates(wsSrc, Array("sku name", "sku编号"))
    availColSrc = FindHeaderByCandidates(wsSrc, _
                        Array("available for whole warehouse", "整仓可用", _
                              "available stock"))
    onwayColSrc = FindHeaderByCandidates(wsSrc, _
                        Array("on the way", "在途中"))
    ordAllocColSrc = FindHeaderByCandidates(wsSrc, _
                        Array("order allocated", "订单已锁"))
    dailySalesColSrc = FindHeaderByCandidates(wsSrc, _
                        Array("forecasted daily sales", "预测日销量"))

    If skuColSrc = 0 Or availColSrc = 0 Or onwayColSrc = 0 _
       Or ordAllocColSrc = 0 Or dailySalesColSrc = 0 Then
        MsgBox "在最新库存数据文件中未找到必要表头：" & vbCrLf & _
               "SKU Name / SKU编号 以及 4 个库存字段。", vbCritical
        GoTo CleanExit
    End If

    ' -------- 3) Load source data into dictionaries (by SKU) --------
    Set dictAvail = CreateObject("Scripting.Dictionary")
    Set dictOnWay = CreateObject("Scripting.Dictionary")
    Set dictOrder = CreateObject("Scripting.Dictionary")
    Set dictDaily = CreateObject("Scripting.Dictionary")
    dictAvail.CompareMode = vbTextCompare
    dictOnWay.CompareMode = vbTextCompare
    dictOrder.CompareMode = vbTextCompare
    dictDaily.CompareMode = vbTextCompare

    lastRowSrc = wsSrc.Cells(wsSrc.Rows.Count, skuColSrc).End(xlUp).Row
    If lastRowSrc < 2 Then GoTo CleanExit

    For r = 2 To lastRowSrc
        sku = Trim$(CStr(wsSrc.Cells(r, skuColSrc).Value))
        If sku <> "" Then
            dictAvail(sku) = NzToZero(wsSrc.Cells(r, availColSrc).Value)
            dictOnWay(sku) = NzToZero(wsSrc.Cells(r, onwayColSrc).Value)
            dictOrder(sku) = NzToZero(wsSrc.Cells(r, ordAllocColSrc).Value)
            dictDaily(sku) = NzToZero(wsSrc.Cells(r, dailySalesColSrc).Value)
        End If
    Next r

    ' -------- 4) Update both target sheets --------
    For i = LBound(SHEETS_TO_UPDATE) To UBound(SHEETS_TO_UPDATE)
        Set wsInv = Nothing
        On Error Resume Next
        Set wsInv = wbInv.Worksheets(CStr(SHEETS_TO_UPDATE(i)))
        On Error GoTo ErrHandler

        If Not wsInv Is Nothing Then
            UpdateOneInventorySheet wsInv, dictAvail, dictOnWay, dictOrder, dictDaily
        End If
    Next i

CleanExit:
    On Error Resume Next
    If Not wbSrc Is Nothing Then wbSrc.Close SaveChanges:=False

    Application.ScreenUpdating = scrn
    Application.Calculation = calc
    Application.EnableEvents = evt
    On Error GoTo 0
    Exit Sub

ErrHandler:
    MsgBox "UpdateInventoryNEW 出错: " & Err.Number & " - " & Err.Description, vbCritical
    Resume CleanExit
End Sub


' ===== Main per-sheet updater =======================================

Private Sub UpdateOneInventorySheet(ByVal wsInv As Worksheet, _
                                   ByVal dictAvail As Object, _
                                   ByVal dictOnWay As Object, _
                                   ByVal dictOrder As Object, _
                                   ByVal dictDaily As Object)

    Dim invWasProtected As Boolean

    Dim skuColInv As Long
    Dim availColInv As Long
    Dim onwayColInv As Long
    Dim ordAllocColInv As Long
    Dim dailySalesColInv As Long

    Dim lastRowInv As Long
    Dim r As Long
    Dim sku As String
    Dim v As Double

    ' -------- If sheet is protected (no password), temporarily unprotect --------
    invWasProtected = wsInv.ProtectContents
    If invWasProtected Then
        On Error Resume Next
        wsInv.Unprotect Password:=""
        On Error GoTo 0
    End If

    ' -------- Headers (SKU + 4 columns) --------
    skuColInv = FindHeaderByCandidates(wsInv, Array("sku"))
    availColInv = FindHeaderByCandidates(wsInv, Array("available stock"))
    onwayColInv = FindHeaderByCandidates(wsInv, Array("on the way"))
    ordAllocColInv = FindHeaderByCandidates(wsInv, Array("order allocated"))
    dailySalesColInv = FindHeaderByCandidates(wsInv, Array("daily sales"))

    If skuColInv = 0 Or availColInv = 0 Or onwayColInv = 0 _
       Or ordAllocColInv = 0 Or dailySalesColInv = 0 Then
        MsgBox "在工作表 [" & wsInv.Name & "] 中未找到必要表头：" & vbCrLf & _
               "SKU / Available Stock / on the way / Order Allocated / Daily Sales", vbCritical
        GoTo SheetCleanExit
    End If

    ' -------- Create/refresh the Update button near SKU header --------
    EnsureUpdateButton wsInv, skuColInv

    ' -------- Determine range --------
    lastRowInv = wsInv.Cells(wsInv.Rows.Count, skuColInv).End(xlUp).Row
    If lastRowInv < 2 Then GoTo SheetCleanExit

    ' -------- Clear old values --------
    wsInv.Range(wsInv.Cells(2, availColInv), wsInv.Cells(lastRowInv, availColInv)).ClearContents
    wsInv.Range(wsInv.Cells(2, onwayColInv), wsInv.Cells(lastRowInv, onwayColInv)).ClearContents
    wsInv.Range(wsInv.Cells(2, ordAllocColInv), wsInv.Cells(lastRowInv, ordAllocColInv)).ClearContents
    wsInv.Range(wsInv.Cells(2, dailySalesColInv), wsInv.Cells(lastRowInv, dailySalesColInv)).ClearContents

    ' -------- Fill columns by SKU --------
    For r = 2 To lastRowInv
        sku = Trim$(CStr(wsInv.Cells(r, skuColInv).Value))
        If sku <> "" Then
            If dictAvail.Exists(sku) Then wsInv.Cells(r, availColInv).Value = dictAvail(sku)
            If dictOnWay.Exists(sku) Then wsInv.Cells(r, onwayColInv).Value = dictOnWay(sku)
            If dictOrder.Exists(sku) Then wsInv.Cells(r, ordAllocColInv).Value = dictOrder(sku)
            If dictDaily.Exists(sku) Then wsInv.Cells(r, dailySalesColInv).Value = dictDaily(sku)
        End If
    Next r

    ' -------- Always subtract offset from Available Stock (no exemptions) --------
    For r = 2 To lastRowInv
        If IsNumeric(wsInv.Cells(r, availColInv).Value) Then
            v = CDbl(wsInv.Cells(r, availColInv).Value)
            wsInv.Cells(r, availColInv).Value = v - AVAILABLE_STOCK_OFFSET
        End If
    Next r

    ' Recalculate this sheet so formulas using these values are up to date
    wsInv.Calculate

SheetCleanExit:
    ' Restore protection if needed
    If invWasProtected Then
        On Error Resume Next
        wsInv.Protect Password:="", UserInterfaceOnly:=True, _
                     AllowSorting:=True, AllowFiltering:=True
        On Error GoTo 0
    End If
End Sub


' ===== UI helper: create a button near SKU header ===================

Private Sub EnsureUpdateButton(ByVal ws As Worksheet, ByVal skuCol As Long)
    Dim btnName As String
    Dim shp As Shape
    Dim leftCell As Range

    btnName = "btnUpdateInventory"

    ' Determine target position: left side of SKU header
    If skuCol > 1 Then
        Set leftCell = ws.Cells(1, skuCol - 1)
    Else
        Set leftCell = ws.Cells(1, skuCol)
    End If

    ' Remove any existing button with the same name
    On Error Resume Next
    ws.Shapes(btnName).Delete
    On Error GoTo 0

    ' Add a simple rectangle button
Set shp = ws.Shapes.AddShape(msoShapeRoundedRectangle, _
                            leftCell.Left + 2, leftCell.Top + 2, _
                            Application.Min(60, leftCell.Width - 6), _
                            Application.Min(20, leftCell.Height - 6))


    With shp
        .Name = btnName
        .TextFrame2.TextRange.Text = "Update"
        .TextFrame2.TextRange.Font.Size = 12
        .TextFrame2.VerticalAnchor = msoAnchorMiddle
        .TextFrame2.TextRange.ParagraphFormat.Alignment = msoAlignCenter
        .OnAction = "UpdateInventoryNEW"
        .Placement = xlMoveAndSize
    End With
End Sub


' ===== Helpers =======================================================

' Find the latest modified .xlsx workbook in a folder
' whose name starts with "Inventory_List" or "库存清单"
Private Function FindLatestWorkbook(ByVal folderPath As String) As String
    Dim f As String
    Dim full As String
    Dim latestTime As Date
    Dim latestFile As String
    Dim baseName As String

    latestTime = 0

    ' Ensure trailing path separator
    If Right$(folderPath, 1) <> "\" And Right$(folderPath, 1) <> "/" Then
        folderPath = folderPath & Application.PathSeparator
    End If

    ' Only consider .xlsx files
    f = Dir(folderPath & "*.xlsx")
    Do While f <> ""
        baseName = f

        ' Accept only names starting with the required prefixes
        If Left$(baseName, Len("Inventory_List")) = "Inventory_List" _
           Or Left$(baseName, Len("库存清单")) = "库存清单" Then

            full = folderPath & f
            If FileDateTime(full) > latestTime Then
                latestTime = FileDateTime(full)
                latestFile = full
            End If
        End If

        f = Dir()
    Loop

    FindLatestWorkbook = latestFile
End Function


' Normalise header text (remove line breaks/symbols, lower-case, squash spaces)
Private Function NormalizeHeader(ByVal txt As String) As String
    Dim s As String

    s = LCase$(CStr(txt))
    s = Replace(s, vbCr, " ")
    s = Replace(s, vbLf, " ")
    s = Replace(s, "*", " ")
    s = Replace(s, "(", " ")
    s = Replace(s, ")", " ")
    s = Replace(s, ":", " ")
    s = Replace(s, ".", " ")

    s = Application.WorksheetFunction.Trim(s)
    Do While InStr(s, "  ") > 0
        s = Replace(s, "  ", " ")
    Loop

    NormalizeHeader = s
End Function

' Find header column in row 1, matching any of the candidate names (fuzzy)
Private Function FindHeaderByCandidates(ByVal ws As Worksheet, _
                                        ByVal candidates As Variant) As Long
    Dim lastCol As Long
    Dim c As Long
    Dim i As Long
    Dim normCell As String
    Dim normCand As String

    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    For c = 1 To lastCol
        normCell = NormalizeHeader(ws.Cells(1, c).Value)
        If normCell <> "" Then
            For i = LBound(candidates) To UBound(candidates)
                normCand = NormalizeHeader(candidates(i))
                If normCand <> "" Then
                    If normCell = normCand _
                       Or InStr(normCell, normCand) > 0 Then
                        FindHeaderByCandidates = c
                        Exit Function
                    End If
                End If
            Next i
        End If
    Next c
End Function

' Convert blanks / non-numeric safely to 0
Private Function NzToZero(v As Variant) As Double
    If IsError(v) Then
        NzToZero = 0
    ElseIf IsNumeric(v) Then
        NzToZero = CDbl(v)
    ElseIf Trim$(CStr(v)) = "" Then
        NzToZero = 0
    Else
        NzToZero = CDbl(Val(CStr(v)))
    End If
End Function


