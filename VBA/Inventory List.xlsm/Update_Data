Option Explicit

Private Const DATA_FOLDER As String = _
    "C:\Users\zouzh\Downloads"


Public Sub UpdateInventoryNEW()
    Dim wbInv As Workbook
    Dim wsInv As Worksheet
    Dim wbSrc As Workbook
    Dim wsSrc As Worksheet

    Dim invWasProtected As Boolean
    Dim latestPath As String

    Dim skuColInv As Long
    Dim availColInv As Long
    Dim onwayColInv As Long
    Dim ordAllocColInv As Long
    Dim dailySalesColInv As Long

    Dim skuColSrc As Long
    Dim availColSrc As Long
    Dim onwayColSrc As Long
    Dim ordAllocColSrc As Long
    Dim dailySalesColSrc As Long

    Dim lastRowInv As Long
    Dim lastRowSrc As Long
    Dim r As Long
    Dim sku As String

    Dim dictAvail As Object
    Dim dictOnWay As Object
    Dim dictOrder As Object
    Dim dictDaily As Object

    Dim scrn As Boolean
    Dim calc As XlCalculation
    Dim evt As Boolean
    Dim v As Double

    On Error GoTo ErrHandler

    Set wbInv = ThisWorkbook
    Set wsInv = wbInv.ActiveSheet   ' 当前库存清单工作表

    ' -------- Speed up --------
    scrn = Application.ScreenUpdating
    calc = Application.Calculation
    evt = Application.EnableEvents

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False

    ' -------- If sheet is protected (no password), temporarily unprotect --------
    invWasProtected = wsInv.ProtectContents
    If invWasProtected Then
        On Error Resume Next
        wsInv.Unprotect Password:=""
        On Error GoTo ErrHandler
    End If

    ' -------- 1) Find latest data workbook --------
    latestPath = FindLatestWorkbook(DATA_FOLDER)
    If latestPath = "" Then
        MsgBox "在库存数据文件夹中未找到任何 Excel 工作簿：" & vbCrLf & DATA_FOLDER, vbCritical
        GoTo CleanExit
    End If

    ' Safely open the latest workbook
    On Error Resume Next
    Set wbSrc = Workbooks.Open(latestPath, ReadOnly:=True)
    If wbSrc Is Nothing Or Err.Number <> 0 Then
        MsgBox "无法打开最新库存数据文件：" & vbCrLf & latestPath & vbCrLf & _
               "错误 " & Err.Number & " - " & Err.Description, vbCritical
        Err.Clear
        On Error GoTo ErrHandler
        GoTo CleanExit
    End If
    On Error GoTo ErrHandler

    If wbSrc.Worksheets.Count = 0 Then
        MsgBox "最新库存数据文件中没有工作表：" & vbCrLf & latestPath, vbCritical
        GoTo CleanExit
    End If

    Set wsSrc = wbSrc.Worksheets(1)  ' 数据文件第一张表，无论英/中文

    ' -------- 2) Inventory List headers (SKU + 4 columns) --------
    skuColInv = FindHeaderByCandidates(wsInv, Array("sku"))
    availColInv = FindHeaderByCandidates(wsInv, Array("available stock"))
    onwayColInv = FindHeaderByCandidates(wsInv, Array("on the way"))
    ordAllocColInv = FindHeaderByCandidates(wsInv, Array("order allocated"))
    dailySalesColInv = FindHeaderByCandidates(wsInv, Array("daily sales"))

    If skuColInv = 0 Or availColInv = 0 Or onwayColInv = 0 _
       Or ordAllocColInv = 0 Or dailySalesColInv = 0 Then
        MsgBox "在当前库存清单中未找到必要表头：" & vbCrLf & _
               "SKU / Available Stock / on the way / Order Allocated / Daily Sales", _
               vbCritical
        GoTo CleanExit
    End If

' -------- 3) Source data headers (English / Chinese) --------
    skuColSrc = FindHeaderByCandidates(wsSrc, Array("sku name", "sku编号"))
    availColSrc = FindHeaderByCandidates(wsSrc, _
                        Array("available for whole warehouse", "整仓可用", _
                              "available stock"))
    onwayColSrc = FindHeaderByCandidates(wsSrc, _
                        Array("on the way", "在途中"))
    ordAllocColSrc = FindHeaderByCandidates(wsSrc, _
                        Array("order allocated", "订单已锁"))
    dailySalesColSrc = FindHeaderByCandidates(wsSrc, _
                        Array("forecasted daily sales", "预测日销量"))


    If skuColSrc = 0 Or availColSrc = 0 Or onwayColSrc = 0 _
       Or ordAllocColSrc = 0 Or dailySalesColSrc = 0 Then
        MsgBox "在最新库存数据文件中未找到必要表头：" & vbCrLf & _
               "SKU Name / SKU编号 以及 4 个库存字段。", vbCritical
        GoTo CleanExit
    End If

    ' -------- 4) Load source data into dictionaries (by SKU) --------
    Set dictAvail = CreateObject("Scripting.Dictionary")
    Set dictOnWay = CreateObject("Scripting.Dictionary")
    Set dictOrder = CreateObject("Scripting.Dictionary")
    Set dictDaily = CreateObject("Scripting.Dictionary")
    dictAvail.CompareMode = vbTextCompare
    dictOnWay.CompareMode = vbTextCompare
    dictOrder.CompareMode = vbTextCompare
    dictDaily.CompareMode = vbTextCompare


    lastRowSrc = wsSrc.Cells(wsSrc.Rows.Count, skuColSrc).End(xlUp).Row
    If lastRowSrc < 2 Then GoTo CleanExit

    For r = 2 To lastRowSrc
        sku = Trim$(CStr(wsSrc.Cells(r, skuColSrc).Value))
        If sku <> "" Then
            dictAvail(sku) = NzToZero(wsSrc.Cells(r, availColSrc).Value)
            dictOnWay(sku) = NzToZero(wsSrc.Cells(r, onwayColSrc).Value)
            dictOrder(sku) = NzToZero(wsSrc.Cells(r, ordAllocColSrc).Value)
            dictDaily(sku) = NzToZero(wsSrc.Cells(r, dailySalesColSrc).Value)
        End If
    Next r

    ' -------- 5) Clear old values in Inventory List --------
    lastRowInv = wsInv.Cells(wsInv.Rows.Count, skuColInv).End(xlUp).Row
    If lastRowInv < 2 Then GoTo CleanExit

    wsInv.Range(wsInv.Cells(2, availColInv), wsInv.Cells(lastRowInv, availColInv)).ClearContents
    wsInv.Range(wsInv.Cells(2, onwayColInv), wsInv.Cells(lastRowInv, onwayColInv)).ClearContents
    wsInv.Range(wsInv.Cells(2, ordAllocColInv), wsInv.Cells(lastRowInv, ordAllocColInv)).ClearContents
    wsInv.Range(wsInv.Cells(2, dailySalesColInv), wsInv.Cells(lastRowInv, dailySalesColInv)).ClearContents

    ' -------- 6) Fill columns by SKU --------
    For r = 2 To lastRowInv
        sku = Trim$(CStr(wsInv.Cells(r, skuColInv).Value))
        If sku <> "" Then
            If dictAvail.Exists(sku) Then
                wsInv.Cells(r, availColInv).Value = dictAvail(sku)
            End If
            If dictOnWay.Exists(sku) Then
                wsInv.Cells(r, onwayColInv).Value = dictOnWay(sku)
            End If
            If dictOrder.Exists(sku) Then
                wsInv.Cells(r, ordAllocColInv).Value = dictOrder(sku)
            End If
            If dictDaily.Exists(sku) Then
                wsInv.Cells(r, dailySalesColInv).Value = dictDaily(sku)
            End If
        End If
    Next r

    ' -------- 7) Subtract 10000 from Available Stock (only when >= 10000) --------
    For r = 2 To lastRowInv
        If IsNumeric(wsInv.Cells(r, availColInv).Value) Then
            v = CDbl(wsInv.Cells(r, availColInv).Value)
            If v >= 10000 Then
                wsInv.Cells(r, availColInv).Value = v - 10000
            End If
        End If
    Next r

    ' Recalculate this sheet so formulas using these values are up to date
    wsInv.Calculate

    MsgBox "库存数据已根据最新文件更新完成。", vbInformation

CleanExit:
    On Error Resume Next
    If Not wbSrc Is Nothing Then wbSrc.Close SaveChanges:=False

    If invWasProtected Then
        wsInv.Protect Password:="", UserInterfaceOnly:=True, _
                     AllowSorting:=True, AllowFiltering:=True
    End If

    Application.ScreenUpdating = scrn
    Application.Calculation = calc
    Application.EnableEvents = evt
    On Error GoTo 0
    Exit Sub

ErrHandler:
    MsgBox "UpdateInventoryNEW 出错: " & Err.Number & " - " & Err.Description, vbCritical
    Resume CleanExit
End Sub


' ===== Helpers =======================================================

' Find the latest modified .xlsx workbook in a folder
' whose name starts with "Inventory_List" or "库存清单"
Private Function FindLatestWorkbook(ByVal folderPath As String) As String
    Dim f As String
    Dim full As String
    Dim latestTime As Date
    Dim latestFile As String
    Dim baseName As String

    latestTime = 0

    ' Ensure trailing path separator
    If Right$(folderPath, 1) <> "\" And Right$(folderPath, 1) <> "/" Then
        folderPath = folderPath & Application.PathSeparator
    End If

    ' Only consider .xlsx files
    f = Dir(folderPath & "*.xlsx")
    Do While f <> ""
        baseName = f

        ' Accept only names starting with the required prefixes
        If Left$(baseName, Len("Inventory_List")) = "Inventory_List" _
           Or Left$(baseName, Len("库存清单")) = "库存清单" Then

            full = folderPath & f
            If FileDateTime(full) > latestTime Then
                latestTime = FileDateTime(full)
                latestFile = full
            End If
        End If

        f = Dir()
    Loop

    FindLatestWorkbook = latestFile
End Function


' Normalise header text (remove line breaks/symbols, lower-case, squash spaces)
Private Function NormalizeHeader(ByVal txt As String) As String
    Dim s As String

    s = LCase$(CStr(txt))
    s = Replace(s, vbCr, " ")
    s = Replace(s, vbLf, " ")
    s = Replace(s, "*", " ")
    s = Replace(s, "(", " ")
    s = Replace(s, ")", " ")
    s = Replace(s, ":", " ")
    s = Replace(s, ".", " ")

    s = Application.WorksheetFunction.Trim(s)
    Do While InStr(s, "  ") > 0
        s = Replace(s, "  ", " ")
    Loop

    NormalizeHeader = s
End Function

' Find header column in row 1, matching any of the candidate names (fuzzy)
Private Function FindHeaderByCandidates(ByVal ws As Worksheet, _
                                        ByVal candidates As Variant) As Long
    Dim lastCol As Long
    Dim c As Long
    Dim i As Long
    Dim normCell As String
    Dim normCand As String

    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    For c = 1 To lastCol
        normCell = NormalizeHeader(ws.Cells(1, c).Value)
        If normCell <> "" Then
            For i = LBound(candidates) To UBound(candidates)
                normCand = NormalizeHeader(candidates(i))
                If normCand <> "" Then
                    If normCell = normCand _
                       Or InStr(normCell, normCand) > 0 Then
                        FindHeaderByCandidates = c
                        Exit Function
                    End If
                End If
            Next i
        End If
    Next c
End Function

' Convert blanks / non-numeric safely to 0
Private Function NzToZero(v As Variant) As Double
    If IsError(v) Then
        NzToZero = 0
    ElseIf IsNumeric(v) Then
        NzToZero = CDbl(v)
    ElseIf Trim$(CStr(v)) = "" Then
        NzToZero = 0
    Else
        NzToZero = CDbl(Val(CStr(v)))
    End If
End Function






